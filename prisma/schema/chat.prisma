model Message {
  id         String    @id @default(cuid())
  content    String?
  senderId   String
  receiverId String
  createdAt  DateTime  @default(now())
  chatRoomId String
  images     String[]
  audios     String[]
  files      String[]
  videos     String[]
  chatType   chatType?
  chatRoom   ChatRoom  @relation(fields: [chatRoomId], references: [id])
  receiver   users     @relation("messagesReceived", fields: [receiverId], references: [id])
  sender     users     @relation("messagesSent", fields: [senderId], references: [id])

  // Critical indexes for messaging performance
  @@index([chatRoomId, createdAt]) // Primary index for loading messages in a room
  @@index([senderId, createdAt])   // For user's sent messages
  @@index([receiverId, createdAt]) // For user's received messages
  @@index([createdAt])             // Global message ordering and cleanup
  @@index([chatRoomId, senderId, createdAt]) // User activity in specific rooms
  @@index([chatType, createdAt])   // Filter by chat type
  // Composite index for pagination
  @@index([chatRoomId, createdAt, id])
}

model ChatRoom {
  id            String       @id @default(cuid())
  user1Id       String
  user2Id       String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  maintenanceId String?      @unique
  user1         users        @relation("chatRoomsUser1", fields: [user1Id], references: [id])
  user2         users        @relation("chatRoomsUser2", fields: [user2Id], references: [id])
  messages      Message[]
  maintenance   maintenance?

  @@unique([user1Id, user2Id])
  
  // Comprehensive chat room indexes
  @@index([user1Id, updatedAt])    // User's chat list sorted by activity
  @@index([user2Id, updatedAt])    // User's chat list sorted by activity
  @@index([maintenanceId])         // Quick lookup for maintenance chats
  @@index([createdAt])             // Room creation ordering
  @@index([updatedAt])             // Activity-based sorting
  // Composite indexes for user chat lists
  @@index([user1Id, updatedAt, id])
  @@index([user2Id, updatedAt, id])
  // For finding rooms by either user
  @@index([user1Id, user2Id, updatedAt])
}

enum chatType {
  MAINTENANCE
  APPLICATION
  SUPPORT
}
